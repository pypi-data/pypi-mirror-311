from .types import (TScanDict, TLoginDict, TLogoutDict, TMessageDict,
                    TContactMessageItem, TGroupMessageDict, TFriendshipItemDict, TGroupInvitationItemDict,
                    TGroupNameChangeItemDict, TGroupMemberJoinItemDict, TGroupMemberLeaveItemDict, TServerErrorDict)
import datetime
from .base import (Contact, Group, MessageType, ScanStatus, ReceiverType, File, FriendshipType, UrlLink)
from .logging_config import logging
from typing import TYPE_CHECKING, List, NoReturn
if TYPE_CHECKING:
    from .bot import WechatBot
logger = logging.getLogger('default')


class EventMeta:
    def __init__(self, service_flag: str,
                 name: str,
                 timestamp: int):

        self.service_flag = service_flag
        self.name = name
        self.timestamp = timestamp


class ServerError:
    def __init__(self, items: TServerErrorDict):
        self.name = items['name']
        self.message = items['message']
        if items.get('stack'):
            self.stack = items['stack']

    def __str__(self):
        return f"ServerError [{self.name}][{self.message}]"


class Scan:
    def __init__(self, items: TScanDict):
        self.qrcode = items['qrcode']
        self.status = ScanStatus(items['status'])

    def __str__(self):
        return f"Scan [{self.status.name}]: {self.qrcode}"


class Login:
    def __init__(self, items: TLoginDict):
        self.contact = Contact(items['contact'])


class Logout:
    def __init__(self, items: TLogoutDict):
        self.contact = Contact(items['contact'])


class Message:
    def __init__(self, items: TMessageDict):
        self.sender = Contact(items['talker'])
        self.text = items['text']
        self.type = MessageType(items['type'])
        self.date = datetime.datetime.fromisoformat(items['date'].replace("Z", "+00:00"))
        self.age = items['age']
        self.is_owner = items['self']
        if items.get('fileBox'):
            self.file = File(items['fileBox'])
        if items.get('urlLink'):
            self.url_link = UrlLink(items['urlLink'])


class ContactGroupMessage(Message):
    def __init__(self, wechat_bot: 'WechatBot', items: TMessageDict):
        super().__init__(items)
        self._wechat_bot = wechat_bot

    async def _forward(self, receiver_type: ReceiverType, receiver_id_list: List[str], interval: int = 1000):

        if self.type == MessageType.Text:
            if receiver_type == ReceiverType.Group:
                await self._wechat_bot.send_group_text_message(self.text,
                                                          receiver_id_list,
                                                          interval)

            elif receiver_type == ReceiverType.Contact:
                await self._wechat_bot.send_contact_text_message(self.text,
                                                          receiver_id_list,
                                                          interval)

        elif self.type in [MessageType.Image,
                           MessageType.Audio,
                           MessageType.Video,
                           MessageType.Attachment]:
            if self.file:
                await self._wechat_bot.forward_file(receiver_type,
                                                    receiver_id_list,
                                                    self.file.id,
                                                    interval)
            else:
                logger.error('This message does not contain a file.')

        # wechaty ÊöÇ‰∏çÊîØÊåÅÂèëÈÄÅUrlÁ±ªÂûãÁöÑÊ∂àÊÅØ
        # elif self.type == MessageType.Url:
        #     await self._wechat_bot.send_url_link(receiver_type,
        #                                          receiver_id_list,
        #                                          self.url_link,
        #                                          interval)
        else:
            logger.error(f'Ê∂àÊÅØÁ±ªÂûã[{self.type.name}]‰∏çÊîØÊåÅËΩ¨Âèë„ÄÇ')

    async def forward_to_contacts(self, contact_id_list: List[str], interval: int = 1000) -> NoReturn:
        await self._forward(ReceiverType.Contact, contact_id_list, interval)

    async def forward_to_groups(self, groups_id_list: List[str], interval: int = 1000) -> NoReturn:
        await self._forward(ReceiverType.Group, groups_id_list, interval)

    async def forward_to_group_with_at(
            self,
            group_id: str,
            member_id_list: List[str],
    ) -> NoReturn:
        if self.type == MessageType.Text:
            await self._wechat_bot.send_group_message_with_at(group_id,
                                                              self.text,
                                                              member_id_list
                                                              )
        else:
            logger.error(f"Ê∂àÊÅØÁ±ªÂûã[{self.type.name}]‰∏çÊîØÊåÅËΩ¨ÂèëÂà∞Áæ§Âπ∂@ÊàêÂëò„ÄÇ")


class ContactMessage(ContactGroupMessage):
    def __init__(self, wechat_bot: 'WechatBot', items: TContactMessageItem):
        super().__init__(wechat_bot, items)
        self.receiver = Contact(items['listener'])

    def __str__(self):
        return f"{'üôã‚Äç‚ôÇÔ∏è' if self.is_owner else ''}ContactMessage [{self.type.name}][{self.sender.name}]: {self.file.name if hasattr(self, 'file') else self.text}"

    async def reply_text(self, text: str) -> NoReturn:
        await self._wechat_bot.send_contact_text_message(text,
                                                    [self.sender.id],
                                                    )



class GroupMessage(ContactGroupMessage):
    def __init__(self, wechat_bot: 'WechatBot', items: TGroupMessageDict):
        super().__init__(wechat_bot, items)
        self.group = Group(items['room'])
        self.mention_list = [Contact(mention_items) for mention_items in items['mentionList']]
        self.mention_self = items['mentionSelf']

    def __str__(self):
        if self.mention_list:
            new_mention_list = [f"@{mention.name}" for mention in self.mention_list]
            mention_str = ", ".join(new_mention_list)
            mention_str = f"[{mention_str}]"
        else:
            mention_str =  ''
        return f"{'üôã‚Äç‚ôÇÔ∏è' if self.is_owner else ''}GroupMessage [{self.type.name}][{self.group.name}][{self.sender.name}]{mention_str}: {self.file.name if hasattr(self, 'file') else self.text}"


    async def remove_sender(self):
        await self._wechat_bot.group_remove_member(self.group.id, [self.sender.id])


    async def reply_text(self, text: str) -> NoReturn:
        await self._wechat_bot.send_group_text_message(text,
                                                    [self.group.id]
                                                  )

    async def reply_text_with_at(self, text: str) -> NoReturn:
        await self._wechat_bot.send_group_message_with_at(self.group.id,
                                                          text,
                                                          [self.sender.id],
                                                          )


class Friendship:
    def __init__(self, wechat_bot: 'WechatBot', items: TFriendshipItemDict):
        self._wechat_bot = wechat_bot
        self.id = items['id']
        self.hello = items['hello']
        self.contact = Contact(items['contact'])
        self.type = FriendshipType(items['type'])

    def __str__(self):
        return f"Friendship [{self.type.name}][{self.contact.name}]: {self.hello}"

    async def accept(self):
        if self.type == FriendshipType.Receive:
            await self._wechat_bot.accept_friend_verify(self.id)


class GroupInvitation:
    def __init__(self, wechat_bot: 'WechatBot', items: TGroupInvitationItemDict):
        self._wechat_bot = wechat_bot
        self.id = items['id']
        self.group_name = items['topic']
        self.inviter = Contact(items['inviter'])
        self.date = datetime.datetime.fromisoformat(items['date'].replace("Z", "+00:00"))
        self.age = items['age']

    async def accept(self):
        await self._wechat_bot.accept_group_invitation(self.id)

class GroupNameChange:
    def __init__(self, items: TGroupNameChangeItemDict):
        self.group = Group(items['room'])
        self.new_name = items['newTopic']
        self.old_name = items['oldTopic']
        self.changer = Contact(items['changer'])


class GroupMemberJoin:
    def __init__(self, items: TGroupMemberJoinItemDict):
        self.group = Group(items['room'])
        self.invitee_list = [Contact(contact_dict) for contact_dict in items['inviteeList']]
        self.inviter = Contact(items['inviter'])


class GroupMemberLeave:
    def __init__(self, items: TGroupMemberLeaveItemDict):
        self.group = Group(items['room'])
        self.leaver_list = [Contact(contact_dict) for contact_dict in items['leaverList']]
        self.remover = Contact(items['remover'])


# class FriendVerify(Message):
#     def __init__(self, instance: 'WechatBot', event: T_event):
#         """
#         EventFriendVerify,  Â•ΩÂèãËØ∑Ê±Ç‰∫ã‰ª∂
#         :param instance:  BotÁ±ªÁöÑÂÆû‰æãÂØπË±°
#         :param event: ‰∫ã‰ª∂dict
#         """
#         super().__init__(event)
#         self._wechat_bot = instance
#         self.to_id: str = event['items']['to_id']
#         self.json_msg: T_json_msg = event['items']['json_msg']
#
#         self.to_name: str = event['items']['json_msg']['to_name']
#         # self.sender.id: str = event['items']['json_msg']['from_id']
#         self.from_nickname: str = event['items']['json_msg']['from_nickname']
#         self.sex: int = event['items']['json_msg']['sex']
#         self.from_content: str = event['items']['json_msg']['from_content']
#         self.headimgurl: str = event['items']['json_msg']['headimgurl']
#         self.mode: int = event['items']['json_msg']['type']
#         if 'from_group_id' in event['items']['json_msg']:
#             self.from_group_id = event['items']['json_msg']['from_group_id']
#
#         """
#         to_id, Ê∂àÊÅØÊé•Êî∂ËÄÖÂæÆ‰ø°ID
#         json_msg,  Â•ΩÂèãÈ™åËØÅ‰ø°ÊÅØÂ≠óÂÖ∏Ôºà1 / Áæ§ÂÜÖÊ∑ªÂä†Êó∂ÔºåÂåÖÂê´Áæ§id
#         to_nameÔºåÊ∂àÊÅØÊé•Êî∂ËÄÖÂæÆ‰ø°ÊòµÁß∞
#         from_idÔºå ÂØπÊñπÂæÆ‰ø°ID
#         from_nicknameÔºå ÂØπÊñπÂæÆ‰ø°ÊòµÁß∞
#         sexÔºå ÂØπÊñπÊÄßÂà´‰ª£Âè∑
#         from_contentÔºå È™åËØÅÂÜÖÂÆπ
#         headimgurlÔºå ÂØπÊñπÂ§¥ÂÉèurl
#         modeÔºå Ê∑ªÂä†ÊñπÂºèÔºå15ÔºöÊêúÁ¥¢Ê∑ªÂä†Ôºå14ÔºöÈÄöËøáÁæ§ËÅäÊ∑ªÂä†
#         from_group_idÔºö Áæ§ËÅäÊ∑ªÂä†ÁöÑ Áæ§ËÅäID
#
#         """
#
#     async def agree(self) -> NoReturn:
#         """
#         ÂêåÊÑèÂ•ΩÂèãËØ∑Ê±Ç
#         :return:
#         """
#         if self.sender.id != self.robot_id:
#             await self._wechat_bot.agree_friend_verify(self.json_msg)
#
#
# class GroupInvite(Message):
#     def __init__(self, instance: 'WechatBot', event: T_event):
#         """
#         EventGroupInvite, ÈÇÄËØ∑ÂÖ•Áæ§‰∫ã‰ª∂
#         :param instance:  BotÁ±ªÁöÑÂÆû‰æãÂØπË±°
#         :param event: ‰∫ã‰ª∂dict
#         """
#         super().__init__(event)
#         self._wechat_bot: 'WechatBot' = instance
#         self.event_name: str = 'EventGroupInvite'
#         self.to_id: str = event['items']['to_id']
#         self.json_msg: T_json_msg = event['items']['msg']
#
#         self.inviter_id: str = event['items']['msg']['inviter_id']
#         self.inviter_nickname: str = event['items']['msg']['inviter_nickname']
#         self.group_headimgurl: str = event['items']['msg']['group_headimgurl']
#         self.group_name: str = event['items']['msg']['group_name']
#         """
#         event_name ‰∫ã‰ª∂ÂêçÁß∞
#         msg_type, Ê∂àÊÅØÁ±ªÂûã
#         to_id, Ê∂àÊÅØÊé•Êî∂ËÄÖ
#         json_msg, Ê∂àÊÅØÂéüjsonÔºå‰ªÖÁî®Êù•ÂêåÊÑèÈÇÄËØ∑Âõû‰º†‰ΩøÁî®
#         inviter_id: ÈÇÄËØ∑ËÄÖÂæÆ‰ø°ID
#         inviter_nicknameÔºöÈÇÄËØ∑ËÄÖÊòµÁß∞
#         group_headimgurlÔºöÁæ§Â§¥ÂÉèurl
#         group_nameÔºöÁæ§Âêç
#         """
#
#     async def agree(self) -> NoReturn:
#         """
#         ÂêåÊÑèÂÖ•Áæ§ËØ∑Ê±Ç
#         :return:
#         """
#         # Âà§Êñ≠ÊòØÂê¶ÊòØËá™Â∑±ÂæÆ‰ø°Âè∑ÈÇÄËØ∑Âà´‰∫∫
#         if self.inviter_id != self.robot_id:
#             await self._wechat_bot.agree_group_invite(self.json_msg)
#
#
# class Group_member_add(Message):
#     def __init__(self, instance: 'WechatBot', event: T_event):
#         """
#         EventGroupMemberAdd,  Áæ§ÊàêÂëòÂ¢ûÂä†‰∫ã‰ª∂
#         :param instance: BotÁ±ªÁöÑÂÆû‰æãÂØπË±°
#         :param event: ‰∫ã‰ª∂dict
#         """
#         super(Group_member_add, self).__init__(event)
#         self._wechat_bot: 'WechatBot' = instance
#         self.guest: List[Dict[str, Any]] = event['items']['json_msg']['guest']
#         self.inviter_id: str = event['items']['json_msg']['inviter']['id']
#         self.inviter_nickname: str = event['items']['json_msg']['inviter']['nickname']
#         """
#
#             guest ËøõÁæ§‰∫∫ÂàóË°®
#             inviter_id ÈÇÄËØ∑‰∫∫ÂæÆ‰ø°ID
#             inviter_nickname ÈÇÄËØ∑‰∫∫ÂæÆ‰ø°ÊòµÁß∞
#         """
#
#     async def reply(self, content: str):
#         await self._wechat_bot.send_text_msg(self.sender.id, content)
#
#
# class Group_member_decrease(Message):
#     def __init__(self, instance: 'WechatBot', event: T_event):
#         """
#         EventGroupMemberDecrease,  Áæ§ÊàêÂëòÂáèÂ∞ë‰∫ã‰ª∂
#         :param instance: BotÁ±ªÁöÑÂÆû‰æãÂØπË±°
#         :param event: ‰∫ã‰ª∂dict
#         """
#         super(Group_member_decrease, self).__init__(event)
#         self._wechat_bot: 'WechatBot' = instance
#         self.member_id: str = event['items']['json_msg']['member_id']
#         self.member_nickname: str = event['items']['json_msg']['member_nickname']
#         """
#         "member_id" ÂáèÂ∞ëÁöÑÊàêÂëòÂæÆ‰ø°ID
#         "member_nickname" ÂáèÂ∞ëÁöÑÊàêÂëòÂæÆ‰ø°ÊòµÁß∞
#         """
#     async def reply(self, content: str):
#         await self._wechat_bot.send_text_msg(self.sender.id, content)
#
#
# class Received_transfer(Message):
#     def __init__(self, instance: 'WechatBot', event: T_event):
#         """
#         EventReceivedTransfer,  Êî∂Âà∞ËΩ¨Ë¥¶‰∫ã‰ª∂
#         :param instance:  BotÁ±ªÁöÑÂÆû‰æãÂØπË±°
#         :param event: ‰∫ã‰ª∂dict
#         """
#         super(Received_transfer, self).__init__(event)
#         self._wechat_bot: 'WechatBot' = instance
#         self.json_msg: T_json_msg = event['items']['json_msg']
#
#         self.paysubtype: str = event['items']['json_msg']['paysubtype']
#         self.is_arrived: int = event['items']['json_msg']['is_arrived']
#         self.is_received: int = event['items']['json_msg']['is_received']
#         self.receiver_pay_id: str = event['items']['json_msg']['receiver_pay_id']
#         self.payer_pay_id: str = event['items']['json_msg']['payer_pay_id']
#         self.money: str = event['items']['json_msg']['money']
#         self.remark: str = event['items']['json_msg']['remark']
#         """
#         "paysubtype" ÊîØ‰ªòÂ≠êÁ±ªÂûã
#         "is_arrived" ÊòØÂê¶Âç≥Êó∂Âà∞Ë¥¶,  Ëøô‰∏™ÂèòÈáèÁî®Êù•Âà§Êñ≠Ëøô‰∏ÄÁ¨îËΩ¨Ë¥¶ÊòØÂê¶ÊòØÊ≠£Â∏∏ÁöÑÔºåÂõ†‰∏∫ÊúâÂèØËÉΩÊòØÂª∂ËøüËΩ¨Ë¥¶Á±ªÂûã
#         "is_received" ÊòØÂê¶Â∑≤ÁªèÊî∂Ê¨æ, Ëøô‰∏™ÂèòÈáèÁî®Êù•Âà§Êñ≠ÊòØÂê¶Êî∂Ê¨æÊàêÂäüÔºåÂõ†‰∏∫Êú¨‰∫ã‰ª∂ÊúâÔºàÊî∂Âà∞ËΩ¨Ë¥¶Ê∂àÊÅØ„ÄÅÂêåÊÑèÊî∂Ê¨æÂêéÁöÑÊ∂àÊÅØ„ÄÅËΩ¨Ë¥¶ËøáÊúüÁöÑÊ∂àÊÅØÔºâËøôÂá†ÁßçÁ±ªÂûãÔºåËøôÈáå‰ª£Ë°®Â∑≤ÁªèÊî∂Âà∞‰∫Ü
#         "receiver_pay_id" Êé•Êî∂ÊñπËÆ¢ÂçïÂè∑
#         "payer_pay_id" ÂèëÈÄÅÊñπËÆ¢ÂçïÂè∑
#         "money", ÈáëÈ¢ù
#         "remark" ËΩ¨Ë¥¶Â§áÊ≥®
#         """
#     async def accept(self):
#         await self._wechat_bot.accept_transfer(self.sender.id, self.json_msg)
#
#
# class Scan_cashMoney:
#     def __init__(self, event: T_event):
#         """
#         EventScanCashMoney,  ‰∫åÁª¥Á†ÅÊî∂Ê¨æ‰∫ã‰ª∂
#         :param event: ‰∫ã‰ª∂dict
#         """
#         self.event_name: str = event['event_name']
#         self.timestamp: int = event['timestamp']
#
#         self.robot_id: str = event['items']['robot_id']
#
#         self.payer_id: str = ''
#         self.payer_nickname: str = ''
#         self.money: str = ''
#         if 'payer_id' in event['items']['json_msg']:
#             self.payer_id = event['items']['json_msg']['payer_id']
#         if 'payer_nickname' in event['items']['json_msg']:
#             self.payer_nickname = event['items']['json_msg']['payer_nickname']
#         if 'money' in event['items']['json_msg']:
#             self.money = event['items']['json_msg']['money']
#         self.msgid: str = event['items']['json_msg']['msgid']
#         self.to_id: str = event['items']['json_msg']['to_id']
#         self.scene_desc: str = event['items']['json_msg']['scene_desc']
#         self.scene: str = event['items']['json_msg']['scene']
#         self.pay_timestamp: int = event['items']['json_msg']['timestamp']
#         """
#         robot_id, , Êî∂Âà∞‰∫ã‰ª∂ÁöÑÊú∫Âô®‰∫∫ÂæÆ‰ø°ID
#         payer_id, , Êâ´Á†Å‰ªòÊ¨æËÄÖÁöÑÂæÆ‰ø°ID
#         payer_nickname, , Êâ´Á†Å‰ªòÊ¨æËÄÖÁöÑÂæÆ‰ø°ÊòµÁß∞
#         money, , ÈáëÈ¢ù
#
#         msgid Ê∂àÊÅØID
#         to_id Êî∂Ê¨æ‰∫∫ÁöÑÂæÆ‰ø°ID
#         scene_desc Âú∫ÊôØËØ¶ÊÉÖ
#         scene Âú∫ÊôØ‰ª£Âè∑
#         pay_timestamp Âú∫ÊôØÂèëÁîüÊó∂Èó¥Êà≥
#
#         """
#
#
# class Plug:
#     def __init__(self, event: T_event):
#         """
#         EventPlug Êèí‰ª∂Ë¢´ÂêØÁî®/ÂÅúÁî®/Êèí‰ª∂ÈáçËΩΩ/Êèí‰ª∂Âç∏ËΩΩ/ËΩØ‰ª∂ÈÄÄÂá∫‰∫ã‰ª∂
#         :param event: ‰∫ã‰ª∂dict
#         """
#         self.event_name: str = 'EventPlug'
#         self.timestamp: int = event['timestamp']
#         if event['event_name'] == 'EventStop':
#             self.type: int = event['items']['type']
#         elif event['event_name'] == 'EventEnable':
#             self.type: int = 4
#     """
#     type, 0 Êèí‰ª∂Ë¢´ÂÅúÁî® / 1 Êèí‰ª∂ÈáçËΩΩ  / 2 Êèí‰ª∂Âç∏ËΩΩ / 3 ÂèØÁà±Áå´ÈÄÄÂá∫ /4 Êèí‰ª∂ÊøÄÊ¥ª
#
#     """
#
#
# class Sys_message:
#     def __init__(self, event: T_event):
#         self.event_name: str = event['event_name']
#         self.timestamp: int = event['timestamp']
#         self.robot_id: str = event['items']['robot_id']
#         self.type: int = event['items']['type']
#         self.json_msg: T_json_msg = event['items']['json_msg']
#     """
#     robot_id, Êú∫Âô®‰∫∫Ë¥¶Âè∑idÔºàÂ∞±ÊòØËøôÊù°Ê∂àÊÅØÊòØÂì™‰∏™Êú∫Âô®‰∫∫ÁöÑÔºåÂõ†‰∏∫ÂèØËÉΩÁôªÂΩïÂ§ö‰∏™Êú∫Âô®‰∫∫Ôºâ
#     type, Ê∂àÊÅØÁ±ªÂûã
#     json_msg, Ê∂àÊÅØÂÜÖÂÆπ
#     """