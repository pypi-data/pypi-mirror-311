{% extends 'base.html' %}

{% block title %}Loguru config{% endblock %}

{% block style %}
<style>
  .el-main {
    text-align: center;
  }
</style>
{% endblock %}

{% block content %}
<div id="app">
  <el-container>
    <el-main>
      <el-row>
        <h1>Loguru 设置</h1>
      </el-row>
      <el-row>
        <el-form inline>
          <el-form-item label="Filter">
            <el-input v-model="filter" placeholder="日志标签"></el-input>
          </el-form-item>
          <el-form-item label="Level">
            <el-select v-model="level" placeholder="日志等级">
              <el-option
                v-for="item in logingLevels"
                :key="item.value"
                :label="item.label"
                :value="item.value">
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item>
            <el-button type="primary" @click="add">add</el-button>
          </el-form-item>
          <el-form-item></el-form-item>
            <el-button type="primary" @click="restore">恢复设置</el-button>
          </el-form-item>
        </el-form>
      </el-row>
      <el-row>
        <el-table :data="handerList" stripe style="width: 100%">
          <el-table-column prop="id" label="id" width="40">
          </el-table-column>
          <el-table-column prop="level" label="level" width="80"></el-table-column>
          <el-table-column prop="levelno" label="levelno" width="80"></el-table-column>
          <el-table-column prop="name" label="name" width="220"></el-table-column>
          <el-table-column prop="formatter" label="formatter"></el-table-column>
          <el-table-column fixed="right" label="操作" width="100">
            <template slot-scope="scope">
              <el-button type="text" @click="remove(scope.row.id)">删除</el-button>
            </template>
          </el-table-column>
        </el-table>
      </el-row>
    </el-main>
  </el-container>
</div>
{% endblock %}

{% block script %}
<script>
// 从Flask模板引擎传递变量
const $BASE_URL = "{{ url_for('logger.remove', id='') }}";
const app = new Vue({
  el: '#app',
  // 分隔符以为 [[]], 避免与Flask模板语言冲突
  delimiters: ['[[', ']]'],
  data: () => ({
    filter: 'gp_flask_ext',
    level: 'INFO',
    base_url: $BASE_URL,
    handerList: [],
    logingLevels: [
      { value: 'TRACE', label: 'TRACE' },
      { value: 'DEBUG', label: 'DEBUG' },
      { value: 'INFO', label: 'INFO' },
      { value: 'SUCCESS', label: 'SUCCESS' },
      { value: 'WARNING', label: 'WARNING' },
      { value: 'ERROR', label: 'ERROR' },
      { value: 'CRITICAL', label: 'CRITICAL' },
    ]
  }),
  methods: {
    add() {
      axios.post("{{ url_for('logger.add') }}", {
        filter: this.filter,
        level: this.level,
      })
      .then(response => {
        console.log(response)
        this.init()
      })
      .catch(error => {
        console.log(error)
      })
    },
    restore() {
      axios.get("{{ url_for('logger.default') }}")
      .then(response => {
        console.log(response)
        this.init()
      })
      .catch(error => {
        console.log(error)
      })
    },
    remove(id) {
      axios.delete(this.base_url + id)
      .then(response => {
        console.log(response)
        this.init()
      })
      .catch(error => {
        console.log(error)
      })
    },
    init() {
      axios.get("{{ url_for('logger.test') }}")
      .then(response => {
        this.handerList = response.data.handlers
      })
      .catch(error => {
        console.log(error)
      })
    }
  },
  mounted() {
    this.init()
  }
})
</script>
{% endblock %}