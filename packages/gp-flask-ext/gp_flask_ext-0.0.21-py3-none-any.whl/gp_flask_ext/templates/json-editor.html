<script>
  // 如果你没有 lodash，可以手动实现 debounce 函数
  function debounce(fn, delay) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn.apply(this, args), delay);
    };
  }
  
  Vue.component('json-editor', {
    template: '<div></div>',
    props: {
      value: Object,
      readonly: Boolean,
      disabled: Boolean
    },
    data() {
      return {
        editor: null
      }
    },
    watch: {
      value: {
        handler(val) {
          if (this.editor) {
            const currentValue = this.editor.get();
            // 避免不必要的更新
            if (JSON.stringify(currentValue) !== JSON.stringify(val)) {
              this.editor.set(val);
            }
          }
        },
        deep: true
      }
    },
    mounted() {
      const container = this.$el;
      const options = {
        mode: this.readonly ? 'view' : 'code',
        modes: ['view', 'form', 'code', 'text'],
        onChange: debounce(() => {
          try {
            const newValue = this.editor.get();
            // 只有当 JSON 有效且不相同时才触发事件
            if (JSON.stringify(newValue) !== JSON.stringify(this.value)) {
              this.$emit('input', newValue);
            }
          } catch (error) {
            // 捕获解析错误，避免报错信息
            // console.error('JSON parsing error:', error);
          }
        }, 300)  // ms 防抖延迟
      };
      this.editor = new JSONEditor(container, options);
      this.editor.set(this.value);  // 初始化时设置编辑器的值

      if (this.disabled) {
        this.editor.aceEditor.container.style.pointerEvents = 'none';  // 禁用交互
        this.editor.aceEditor.renderer.$cursorLayer.element.style.display = 'none';  // 隐藏光标
      }
    },
    beforeDestroy() {
      // 组件销毁时销毁 JSONEditor 实例，防止内存泄漏
      if (this.editor) {
        this.editor.destroy();
        this.editor = null;
      }
    }
  });
  </script>
  