{% extends 'base.html' %}

{% block title %}ChatGPT{% endblock %}

{% block style %}
<link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.10.0/styles/default.min.css">
{% endblock %}

{% block content %}
<div id="app" v-loading="loading">
  <el-container>
    <el-main>
      <el-row>
        <h1>ChatGPT</h1>
      </el-row>
      <el-row>
        <el-form ref="form" :model="form" label-width="80px">
          <el-form-item label="提问">
            <el-input v-model="form.user_input" 
              @compositionstart="start"
              @compositionend.stop="end"
              @keyup.enter.native="ask" placeholder="输入问题">
              <i slot="suffix" class="el-input__icon el-icon-upload"></i>
            </el-input>
          </el-form-item>
          <div v-show="show">
            <el-form-item label="模型">
              <el-select v-model="form.model" filterable placeholder="模型">
                <el-option v-for="item in models" :key="item.id" :label="item.id" :value="item.id"></el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="最大字数">
              <el-slider v-model="form.max_tokens" :min="1" :max="2048" :step="32"></el-slider>
            </el-form-item>
            <el-form-item label="温度">
              <el-slider v-model="form.temperature" :min="0" :max="1" :step="0.1"></el-slider>
            </el-form-item>
            <el-form-item label="Top P">
              <el-slider v-model="form.top_p" :min="0" :max="1" :step="0.1"></el-slider>
            </el-form-item>
            <el-form-item label="频率惩罚">
              <el-slider v-model="form.frequency_penalty" :min="0" :max="2" :step="0.1"></el-slider>
            </el-form-item>
            <el-form-item label="存在惩罚">
              <el-slider v-model="form.presence_penalty" :min="0" :max="2" :step="0.1"></el-slider>
            </el-form-item>
          </div>
          <el-form-item>
            <el-button type="primary" @click="ask">提问</el-button>
            <el-button @click="show = !show">高级选项</el-button>
          </el-form-item>
        </el-form>
      </el-row>
      <el-row>
        <div id="md"></div>
        <el-button-group v-show="answer">
          <el-tooltip content="复制">
            <el-button icon="el-icon-document-copy" @click="copyToClipboard" round></el-button>
          </el-tooltip>
          <el-tooltip content="阅读">
            <el-button :icon="buttonIconClass" @click="readingAnswer" round></el-button>
          </el-tooltip>
          <el-tooltip content="刷新">
            <el-button icon="el-icon-refresh-right" @click="ask" round></el-button>
          </el-tooltip>
        </el-button-group>
      </el-row>
    </el-main>
  </el-container>
</div>
{% endblock %}

{% block script %}
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.10.0/highlight.min.js"></script>
<script src="https://unpkg.com/marked@14.1.2/lib/marked.umd.js"></script>
<script>
  const DEFAULT_MAX_TOKENS = {{ max_tokens }}; // 默认最大字数, 从Flask模板引擎传递变量
  // const DEFAULT_MODEL = "{{ model }}";
  // 从Flask模板引擎传递变量
  const app = new Vue({
    el: '#app',
    // 分隔符以为 [[]], 避免与Flask模板语言冲突
    delimiters: ['[[', ']]'],
    data: () => ({
      form: {
        user_input: "",
        model: "",
        max_tokens: DEFAULT_MAX_TOKENS,
        temperature: 0.5,
        top_p: 1.0,
        frequency_penalty: 1.0,
        presence_penalty: 1.0,
      },
      show: false,    // 是否显示高级选项
      models: [
        { id: "4o-test" },
      ],
      answer: "",
      loading: false,
      speaking: false,
      isComposing: false, // 是否正在输入
    
    }),
    computed: {
      buttonIconClass() {
        return this.speaking ? 'el-icon-loading' : 'el-icon-reading';
      }
    },
    methods: {
      init() {
        this.models = axios.get("{{ url_for('chatgpt.models') }}")
          .then(response => {
            this.models = response.data.data
            this.$nextTick(() => {
              this.form.model = this.models[0].id
            })
          })
      },
      start(e) {
        this.isComposing = true
      },
      end(e) {
        setTimeout(() => {
          this.isComposing = false
        }, 500)
      },
      ask() {
        if (this.isComposing) {
          return
        }
        this.loading = true
        axios.post("{{ url_for('chatgpt.ask') }}", this.form)
          .then(response => {
            this.answer = response.data
            const el = document.getElementById("md");
            el.innerHTML = marked.parse(this.answer)
            hljs.highlightAll()
            this.loading = false
          })
          .catch(error => {
            console.log(error)
            this.$message.error('请求失败')
            this.loading = false
          })
      },
      copyToClipboard() {
        navigator.clipboard.writeText(this.answer)
        this.$message.success('复制成功')
      },
      readingAnswer() {
        // 判断是否正在播放
        if (window.speechSynthesis.speaking) {
          // console.log("speaking")
          window.speechSynthesis.cancel()
          return
        } else {
          // console.log("not speaking")
        }
        // 创建一个新的 SpeechSynthesisUtterance 实例
        const utterance = new SpeechSynthesisUtterance(this.answer)
        window.speechSynthesis.speak(utterance)
        utterance.onstart = () => {
          console.log("speaking start")
          this.speaking = true
        };
        utterance.onend = () =>  {
          console.log("speaking end")
          this.speaking = false
        };
      }
    },
    mounted() {
      this.init()
    }
  })
</script>
{% endblock %}