<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>{{ _("File sharing") }}</title>
    <link rel="stylesheet" href="{{ url_for("static", filename="style.css", _external=True) }}" />
    <script>
        function upload_file()
        {
            var fd = new FormData();
            fd.append("file", document.getElementById("file").files[0]);
            fd.append("retention", document.getElementById("retention").value);

            var xhr = new XMLHttpRequest();
            xhr.overrideMimeType("application/json");
            xhr.upload.addEventListener("progress", upload_progress, false);
            xhr.addEventListener("load", upload_complete, false);
            xhr.addEventListener("error", upload_failed, false);
            xhr.addEventListener("abort", upload_canceled, false);

            xhr.open("POST", "{{ url_for("upload", _external=True) }}");
            xhr.send(fd);
            
            document.getElementById("cancel").onclick = function() { xhr.abort(); return false; };
        }

        function upload_progress(evt)
        {
            if(evt.lengthComputable)
            {
                document.getElementById("response").style.visibility = "visible";
                
                var progress = Math.round(100*evt.loaded/evt.total);
                document.getElementById("progress").value = progress;
                document.getElementById("progress_value").innerHTML = progress.toString() + " %";
            }
            else
            {
                document.getElementById("response").innerHTML = "cannot compute progress";
            }
        }

        function upload_complete(evt)
        {
            // Redirect to update file list.
            window.location.replace("{{ url_for("index", _external=True) }}"); 
        }

        function upload_failed(evt)
        {
            alert("Error during upload");
        }

        function upload_canceled(evt)
        {
            document.getElementById("response").style.visibility = "hidden";
        }
        
        function confirm_delete(name)
        {
            return confirm("{{ _("Are you sure you want to delete") }} \""+name+"\"?");
        }
        
        function file_selected()
        {
            var filename = document.getElementById("file").value;
            if(filename)
            {
                document.getElementById("upload").disabled = "";
            }
        }

    </script>
</head>

<body>
    <div id="container">
        <h1>{{ _("File sharing") }}</h1>
        
        <a id="logout" href="{{ url_for("logout", _external=True) }}">{{ _("logout") }}</a>

        <form method="post" action="{{ url_for("upload", _external=True) }}" enctype="multipart/form-data" id="upload_form">
            <label for="file">{{ _("Select a file: ") }}</label><input type="file" id="file" name="file" onchange="file_selected()"/><br />
            <label for="retention">{{ _("Retention: ") }}</label>
            <select size="1" id="retention" name="retention"/>
                <option value="1" label="{{ _("One day") }}">{{ _("One day") }}</option>
                <option value="7" label="{{ _("One week") }}">{{ _("One week") }}</option>
                <option value="30" selected="selected" label="{{ _("One month") }}">{{ _("One month") }}</option>
                <option value="60" selected="selected" label="{{ _("Two months") }}">{{ _("Two months") }}</option>
            </select><br />
            <input type="button" id="upload" value="{{ _("Upload fileâ€¦") }}" onclick="upload_file()" disabled="disabled"/>
        </form>
        <div id="response">
            <progress id="progress" value="0" max="100"></progress>
            <span id="progress_value"></span>
            <input type="button" id="cancel" value="{{ _("Cancel upload") }}" />
        </div>

        <div>
        <table id="files">
            <thead>
                <tr>
                    <th>{{ _("Name") }}</th>
                    <th>{{ _("Links") }}</th>
                    <th>{{ _("Upload date") }}</th>
                    <th>{{ _("Retention") }}</th>
                    <th>{{ _("Download count") }}</th>
                </tr>
            </thead>
            <tbody>
            {% for file in files %}
                <tr>
                    <td>{{ file.name }}</td>
                    <td>
                        <a href="{{ 
                            url_for("download", id=file.id, _external=True) 
                        }}">{{ _("Download") }}</a> | <a href="{{ 
                            url_for("delete", delete_id=file.delete_id, _external=True) 
                        }}" onclick="return confirm_delete('{{ file.name }}')">{{ _("Delete") }}</a></td>
                    <td>{{ format_date(file.upload_date) }}</td>
                    <td>
                        {{ file.retention.days }} {{ _("days") }}<br>
                        {{ format_date(file.upload_date+file.retention) }}
                    </td>
                    <td>{{ file.download_count }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
    <div id="footer"><small>Powered by FishPie 1.1.1</small></div>
</body>

</html>
